<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:avalonia="clr-namespace:Material.Icons.Avalonia;assembly=Material.Icons.Avalonia"
             xmlns:vm="clr-namespace:Aesir.Client.ViewModels"
             xmlns:cl="clr-namespace:CommunityToolkit.Mvvm.Collections;assembly=CommunityToolkit.Mvvm"
             xmlns:controls="clr-namespace:Aesir.Client.Controls"
             mc:Ignorable="d"
             x:DataType="vm:ChatHistoryViewModel"
             x:Class="Aesir.Client.Controls.ChatHistory">
    <UserControl.Styles>
        <Style Selector="MenuFlyoutPresenter.userMenu">
            <Setter Property="MinWidth" Value="{Binding $parent[Button].Bounds.Width}" />
        </Style>
    </UserControl.Styles>

    <DockPanel Background="{DynamicResource BackgroundBrush}">
        <TextBox DockPanel.Dock="Top"
                 Classes="Bordered"
                 BorderThickness="1"
                 Watermark="Search"
                 Text="{Binding SearchText, Mode=TwoWay}"
                 Margin="8,60,8,8">
            <TextBox.InnerLeftContent>
                <Border Height="{Binding $parent[TextBox].Height}"
                        Width="{Binding $self.Bounds.Height}">
                    <avalonia:MaterialIcon
                        HorizontalAlignment="Center"
                        VerticalAlignment="Center"
                        Kind="Magnify" Width="20" Height="20" />
                </Border>
            </TextBox.InnerLeftContent>
        </TextBox>
        
        <!-- User Profile Panel - Docked to Bottom -->
        <Border DockPanel.Dock="Bottom" Padding="10" Margin="0 0 0 0">
            <Button Classes="Primary" 
                    Theme="{DynamicResource OutlineButton}"
                    HorizontalAlignment="Stretch"
                    HorizontalContentAlignment="Left"
                    Padding="10,7,7,7">
                <Button.Flyout>
                    <MenuFlyout Placement="Top" FlyoutPresenterClasses="userMenu">
                        <MenuItem Header="Agents" Command="{Binding ShowAgents}">
                            <MenuItem.Icon>
                                <avalonia:MaterialIcon Kind="Robot" />
                            </MenuItem.Icon>
                        </MenuItem>
                        <MenuItem Header="Tools" Command="{Binding ShowTools}">
                            <MenuItem.Icon>
                                <avalonia:MaterialIcon Kind="Tools" />
                            </MenuItem.Icon>
                        </MenuItem>
                        <MenuItem Header="MCP Servers" Command="{Binding ShowMcpServers}">
                            <MenuItem.Icon>
                                <avalonia:MaterialIcon Kind="Dns" />
                            </MenuItem.Icon>
                        </MenuItem>
                    </MenuFlyout>
                </Button.Flyout>
                <StackPanel Orientation="Horizontal" Spacing="12">
                    <avalonia:MaterialIcon Kind="Cog" 
                                           Width="18" 
                                           Height="18" 
                                           HorizontalAlignment="Center" 
                                           VerticalAlignment="Center" />
                    <TextBlock Text="Bobby Langford"
                               VerticalAlignment="Center"
                               FontWeight="Medium" />
                </StackPanel>
            </Button>
        </Border>

        <ScrollViewer Margin="0,0,0,0" VerticalScrollBarVisibility="Auto">
            <ItemsControl ItemsSource="{Binding ChatHistoryByDate}">
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <StackPanel>
                            <TextBlock Classes="Quaternary" Padding="10,0,0,0" Text="{Binding DataType=cl:IReadOnlyObservableGroup, Path=Key}" />
                            <ItemsRepeater ItemsSource="{Binding }">
                                <ItemsRepeater.ItemTemplate>
                                    <DataTemplate x:DataType="vm:ChatHistoryButtonViewModel" >
                                        <controls:ChatHistoryButton />
                                    </DataTemplate>
                                </ItemsRepeater.ItemTemplate>
                            </ItemsRepeater>
                        </StackPanel>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>
    </DockPanel>
</UserControl>